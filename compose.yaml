x-customizable-image: &customizable_image
 image: ${CUSTOM_IMAGE:-frappe/erpnext}:${CUSTOM_TAG:-$ERPNEXT_VERSION}
 pull_policy: ${PULL_POLICY:-always}
 restart: ${RESTART_POLICY:-unless-stopped}

x-depends-on-configurator: &depends_on_configurator
 depends_on:
 configurator:
 condition: service_completed_successfully

x-backend-defaults: &backend_defaults
 <<: [*depends_on_configurator, *customizable_image]
 volumes:
 - sites:/home/frappe/frappe-bench/sites

services:
 redis:
 image: redis:7-alpine
 restart: unless-stopped

 configurator:
 <<: *backend_defaults
 platform: linux/amd64
 entrypoint: [bash, -c]
 command: >
 ls -1 apps > sites/apps.txt;
 bench set-config -g db_host $$DB_HOST;
 bench set-config -gp db_port $$DB_PORT;
 bench set-config -g db_name $$DB_NAME;
 bench set-config -g db_password $$DB_PASSWORD;
 bench set-config -g redis_cache "redis://$$REDIS_CACHE";
 bench set-config -g redis_queue "redis://$$REDIS_QUEUE";
 bench set-config -g redis_socketio "redis://$$REDIS_SOCKETIO";
 bench set-config -gp socketio_port $$SOCKETIO_PORT;
 environment:
 DB_HOST: ${DB_HOST}
 DB_PORT: ${DB_PORT:-3306}
 DB_NAME: ${DB_NAME}
 DB_USER: ${DB_USER}
 DB_PASSWORD: ${DB_PASSWORD}
 REDIS_CACHE: ${REDIS_CACHE:-redis:6379/1}
 REDIS_QUEUE: ${REDIS_QUEUE:-redis:6379/2}
 REDIS_SOCKETIO: ${REDIS_SOCKETIO:-redis:6379/3}
 SOCKETIO_PORT: 9000

 SITE_NAME: ${SITE_NAME:-v2.sysmayal.cloud}
 ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
 INSTALL_APPS: ${INSTALL_APPS:-erpnext}
 depends_on:
 - redis
 restart: on-failure

 backend:
 <<: *backend_defaults
 platform: linux/amd64

 frontend:
 <<: *customizable_image
 platform: linux/amd64
 command: [nginx-entrypoint.sh]
 environment:
 BACKEND: backend:8000
 SOCKETIO: websocket:9000
 FRAPPE_SITE_NAME_HEADER: ${FRAPPE_SITE_NAME_HEADER:-$$host}
 UPSTREAM_REAL_IP_ADDRESS: ${UPSTREAM_REAL_IP_ADDRESS:-187.77.2.74}
 UPSTREAM_REAL_IP_HEADER: ${UPSTREAM_REAL_IP_HEADER:-X-Forwarded-For}
 UPSTREAM_REAL_IP_RECURSIVE: ${UPSTREAM_REAL_IP_RECURSIVE:-off}
 PROXY_READ_TIMEOUT: ${PROXY_READ_TIMEOUT:-120}
 CLIENT_MAX_BODY_SIZE: ${CLIENT_MAX_BODY_SIZE:-50m}
 volumes:
 - sites:/home/frappe/frappe-bench/sites
 depends_on:
 - backend
 - websocket
 networks:
 - default
 - n8n_default
 labels:
 - traefik.enable=true
 - traefik.http.routers.sysmayal2.rule=Host(`${SITE_NAME:-v2.sysmayal.cloud}`)
 - traefik.http.routers.sysmayal2.entrypoints=websecure
 - traefik.http.routers.sysmayal2.tls=true
 - traefik.http.services.sysmayal2.loadbalancer.server.port=8080

 websocket:
 <<: [*depends_on_configurator, *customizable_image]
 platform: linux/amd64
 command: [node, /home/frappe/frappe-bench/apps/frappe/socketio.js]
 volumes:
 - sites:/home/frappe/frappe-bench/sites

 queue-short:
 <<: *backend_defaults
 platform: linux/amd64
 command: bench worker --queue short,default

 queue-long:
 <<: *backend_defaults
 platform: linux/amd64
 command: bench worker --queue long,default,short

 scheduler:
 <<: *backend_defaults
 platform: linux/amd64
 command: bench schedule

volumes:
 sites:

networks:
 n8n_default:
 external: true
